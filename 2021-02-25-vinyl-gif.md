---
title: "Let's Build: Spinning Vinyl GIF Generator"
author: joseph
layout: post
tags:
  - letsbuild
  - ffmpeg
  - video-encode-robot
  - python
  - python-sdk
meta_description: >-
  In this blog, we build spinning vinyl gif generator!
emojify: true
---
# Let's Build: Spinning Vinyl GIF Generator

As a newly hired member of our support team, I was familiarizing myself with our services when I came across a Stack Overflow question that piqued my interest as it allowed me to combine my love of music with our API. The question was if we could use our services to generate Spinning Vinyl GIFs, and we thought the idea was interesting enough to turn into a blog.

This blog covers some exciting practices you may wish to use in your projects and shows the versatility of our service. We will be covering concepts such as using our [Python SDK](https://transloadit.com/docs/#python-sdk) with external libraries to combine internal and external encoding, asynchronously combining two templates, and using FFmpeg to expand the capabilities of our API. So without further ado, let's just right in by looking at what we need to get started.

## prerequisites

Besides our before-mentioned Python SDK, we need to download a few other tools for our project today. We'll use the open-source tool [OpenCV](https://pypi.org/project/opencv-python/), which allows us to perform bitwise calculations on images, alongside many different image and video processing options. Additionally, in tandem with OpenCV we'll use [NumPy package](https://numpy.org/) to help with local image processing.

Coupled with our tools, we need some assets to use, which you can download at the link below:

- [Vinyl Record Background](https://raw.githubusercontent.com/transloadit/content/vinyl-gif-maker-blog/_assets/images/blog/2021-02-vinyl-gif/vinyl.png?token=AI2IIRNEF6REQWFC4GLXV6DAG6R7O)
- [Album Art *(Necessary)*](https://github.com/transloadit/content/raw/vinyl-gif-maker-blog/_assets/images/blog/2021-02-vinyl-gif/okcomputer.jpg)

## Setting up our project

The first thing we want to do is create a project folder and install all the necessary packages. To do so, run the following commands inside your console.

- `pip install pytransloadit`
- `pip install numpy`
- `pip install opencv-python`
- `pip install requests`
- `pip install future`

We will break our code into chunks for explanation purposes, but if you wish to download the complete project and any of the assets used within this blog, please see the following Github [repo[]](https://github.com/Missing-Tech/Vinyl-Gif-Maker).

Create a python file and import our packages.

```
from __future__ import print_function
from transloadit import client
import os
import requests
import cv2
import numpy as np
```

Next, create an instance of the Transloadit client.

```
tl = client.Transloadit(TRANSLOADIT_KEY, TRANSLOADIT_SECRET)
```

We need to create a /Assets/ folder within our project folder and a ../Frames inside. Inside of Assets put the two images from earlier.

Finishing up, let's create some global variables to refer to later. Make sure img_name matches the name of the album image, and that vinyl_path matches the name of the background image.

```
img_name = 'okcomputer'
img_path = 'Assets/{name}.jpg'.format(name=img_name)
vinyl_path = 'Assets/vinyl.png'
remove_bg_location = 'Assets/trimmed_image.png'
```

**We should be all set up now so lets make our first template!**

## Templates

### Making a template

Head to your Transloadit console and create a blank template making sure to note down your `template ID` for later. Below we have copied over our template code which is simply the JSON recipe to create your Transloadit magic. We'll go through each step and explain what's going on. 

```
{
  "steps": {
    ":original": {
      "robot": "/upload/handle"
    },
    "resize": {
      "use": ":original",
      "robot": "/image/resize",
      "format": "png",
      "resize_strategy": "fillcrop",
      "width": 350,
      "height": 350,
      "imagemagick_stack": "v2.0.7"
    }
  }
}
```

Beginning our step `:original`uploads our input file; however, if you want to upload a file from a third party service, you can find all supported services at the following [documentation](https://transloadit.com/docs/transcoding/#service-file-importing).

Next, `resize` handles cropping our image and sets the format to PNG. This is necessary to ensure that the image is properly scaled on the vinyl record at the end.

## Using our templates

Since we are using multiple templates, we need to create a small python script to link our templates. We will accomplish this by parsing our first templates assembly result and taking the resulted *temporary* URL of our first image. We're going to send an HTTP request later to it, so we can download our image locally.

The function below is passed our previously noted template ID, the file path of the image we want to upload, the name of the last step in our template (so for our example it would be "resize"); as well as some optional parameters, like whether we want to return the URL - which we'll default to `True`, and most importantly *fields*. Using fields we can pass variables into our template so we can change parameters of our template from our client, handy ðŸ‘Œ

```
def useTemplate(templateID, file_path='', result_name='', get_url=True, fields=''):
    # Creates a new assembly on our Transloadit client using our template ID and specified fields
    assembly = tl.new_assembly({'template_id': templateID, 'fields': fields})

    # Adds the file to the assembly
    if file_path != '':
        assembly.add_file(open(file_path, 'rb'))

    # Attempts to create an assembly, if it fails after 5 tries it'll throw an error
    assembly_response = assembly.create(retries=5, wait=True)
    if get_url:
        # Parses the JSON returned from the assembly to find the URL of our result
        # Since, in our templates we're not exporting the file it gets stored on Transloadit servers
        # For a maximum of 24 hours
        assembly_url = assembly_response.data.get('results').get(result_name)[0].get('ssl_url')
        return assembly_url

```

We also need to create one more utility function to download our image to our Assets folder. All this does is send a request to our URL, create a new image at a file location, then write the contents of our HTTP request to that location. 

```
def downloadImage(url, location):
    # Sends a request to the url
    r = requests.get(url)
    # Downloads the content locally
    image = open(location, 'wb')
    image.write(r.content)
    image.close()
```

### Removing the Background

```
{
  "steps": {
    ":original": {
      "robot": "/upload/handle"
    },
    "trimmed": {
      "use": ":original",
      "robot": "/image/resize",
      "alpha": "Activate",
      "type": "TrueColor",
      "transparent": "0,0,0",
      "imagemagick_stack": "v2.0.7"
    }
  }
}
```

This template is straightforward; it will enable the alpha channel on our PNG image and then set all black pixels (0,0,0) transparent. However, this also means that we have to be careful if we're using album art with a black background - such as the [Dark Side of the Moon by Pink Floyd](https://github.com/Missing-Tech/Vinyl-Gif-Maker/blob/main/.github/images/darkside.gif).

### Overlaying the image

Now for some fields magicâœ¨. We're going to take the URL of the image from our last step and pass that in as a field into our template. The /image/resize robot will use the image at the URL to overlay it ontop of our vinyl record.

```
{
  "steps": {
    ":original": {
      "robot": "/upload/handle"
    },
    "watermark": {
      "use": ":original",
      "robot": "/image/resize",
      "watermark_url": "${fields.url}",
      "watermark_size": "33%",
      "watermark_position": "center",
      "imagemagick_stack": "v2.0.7"
    }
  }
}
```

### Making it a GIF!

This is our last template. It might look daunting, but it's actually quite simple.

```
{
  "steps": {
    "import": {
      "robot": "/http/import",
      "url": "${fields.url}",
      "result": true
    },
    "animated": {
      "robot": "/video/merge",
      "use": "import",
      "result": true,
      "duration": "${fields.duration}",
      "framerate": "${fields.framerate}",
      "ffmpeg_stack": "v4.3.1",
      "ffmpeg": {
        "vf": "rotate=3.1415926535898*t:c=white@0, loop = -1",
        "f": "gif",
        "pix_fmt": "rgb24"
      }
    }
  }
}
```

Starting off, "import" is used to, well, import our file. We use our [/http/import](https://transloadit.com/docs/transcoding/#http-import) Robot to bypass having to download our image from the previous step locally. This requires a URL to import from of course. Luckily, we can easily use the field we made to pass a URL from our Python script.  

Now, this is where we use FFmpeg to create our desired spinning effect. We take the overlayed image and use the rotate video flag, supply a number in radians, and times it by the frame number (t). Since we want one full rotation, looped, we use pi. By appending c:white@0 we can set the background color on our gif to white. Lastly, loop=-1 will make the gif infinitely loop. 

## Tying it all together in Python

Now we should have all the pieces we need to make our spinning vinyl GIF!

Let's start by resizing the image and downloading it locally:

```
# Resize the image using a template
# Automatically converts it to a png
resize_url = useTemplate([RESIZE_IMAGE_TEMPLATE_ID], img_path, 'resize')
# Download the image locally
resized_image_location = 'Assets/resized_image.png'
downloadImage(resize_url, resized_image_location)
```

Next, we need to make our image masking function. Let's call it `maskImage` and give it an `img_path`. 

```
def maskImage(img_path):
    # Reads the input image
    img = cv2.imread(img_path)
    # Creates a mask with the same size as the image
    mask = np.zeros(img.shape, dtype=np.uint8)
    # Creates a white circle in the centre
    mask = cv2.circle(mask, (175, 175), 175, (255, 255, 255), -1)
    # Makes a small whole in the centre of the mask
    mask = cv2.circle(mask, (175, 175), 20, (0, 0, 0), -1)
    result = cv2.bitwise_and(img, mask)

    result_location = 'Assets/mask.png'
    cv2.imwrite(result_location, result)
    
    # However this leaves a black BG which we don't want
    # You can use the transloadit transparent parameter on the /image/resize robot for this
    # By setting transparent to 0,0,0 it sets all black pixels to transparent
    remove_bg_url = useTemplate([REMOVING_BG_TEMPLATE_ID], result_location, 'trimmed')
    downloadImage(remove_bg_url, remove_bg_location)
    return remove_bg_url
```

The beginning of our function creates a black image with the exact dimensions as our album art, then create two white circles to produce a donut like so:

![](https://raw.githubusercontent.com/Missing-Tech/Vinyl-Gif-Maker/main/.github/images/mask2.png)

We then perform a *bitwise AND operation* on both the mask and our original image, meaning that a pixel from the original image is only shown in places where the mask has a white pixel. This gives us this result:

![](https://raw.githubusercontent.com/Missing-Tech/Vinyl-Gif-Maker/main/.github/images/mask.png)

Finally, using our template from earlier will make all the black pixels transparent.

![](https://raw.githubusercontent.com/Missing-Tech/Vinyl-Gif-Maker/main/.github/images/trimmed.png)

We'll call our function like so:

```
# Masks the image
trimmed_url = maskImage(resized_image_location)
```

Now we need to put our donut on the vinyl record and make it spin!
Let's watermark the image using our template from earlier:

```
# Now we add the watermark to the vinyl
finished_watermarked_location = 'Assets/vinyl_finished.png'
vinyl_url = useTemplate([WATERMARK_IMAGE_TEMPLATE_ID], vinyl_path, 'watermark', True, {'url': trimmed_url})
```

This gives us this result:

![](https://raw.githubusercontent.com/Missing-Tech/Vinyl-Gif-Maker/main/.github/images/overlayed.png)

Now lets make it spin!

```
# Framerate of our animation
frame_rate = 60
# Length of our animation in seconds
length = 2

# Makes it into a GIF using the image we just made
final_gif_url = useTemplate('[ROTATING_GIF_TEMPLATE_ID]',
                            result_name='animated',
                            get_url=True,
                            fields={'url': vinyl_url, 'duration': length, 'framerate': frame_rate})
```

This makes our image smoothly rotate, passing in our still image, and also a framerate and length which we define from our script.

Finally, we can download our result locally.

```
final_gif_location = 'Assets/finished_gif.gif'
downloadImage(final_gif_url, final_gif_location)
```

Meaning we finally have our *spinning vinyl*!ðŸŽ‰

![](https://github.com/Missing-Tech/Vinyl-Gif-Maker/blob/main/.github/images/finished_gif.gif?raw=true)

**Congratulations on making it this far!** I know its been long, but I hope you agree that our result is worth it :)

I hope you enjoyed making this, and maybe you've learned some things about the Transloadit API that you can use on your next project! If you want to take this project even further, why not make it an MP4, add some music to go along with the vinyl record, or use [Uppy](https://uppy.io/) to let users upload their own image on the web to put on a vinyl record?